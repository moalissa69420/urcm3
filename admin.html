<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URCM - Admin Lap Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-container h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .login-container input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .login-container button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-container button:hover {
            background: #5568d3;
        }

        .error-message {
            color: #e53e3e;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Admin Panel */
        #admin-panel {
            display: none;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
        }

        .logout-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .init-btn {
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .init-btn:hover {
            background: #38a169;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .runner-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .runner-item:last-child {
            border-bottom: none;
        }

        .runner-info {
            display: flex;
            flex-direction: column;
        }

        .runner-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .runner-stats {
            font-size: 0.9em;
            color: #718096;
        }

        .lap-count {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            min-width: 80px;
        }

        .lap-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .lap-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .lap-btn:active {
            transform: translateY(0);
        }

        .undo-btn {
            padding: 8px 16px;
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .undo-btn:hover {
            background: #f56565;
        }

        .edit-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .edit-btn:hover {
            background: #38a169;
        }

        .name-edit-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .finisher-btn {
            background: #48bb78;
            color: white;
        }

        .finisher-btn:hover {
            background: #38a169;
        }

        .finisher-btn.active {
            background: #2f855a;
            box-shadow: 0 0 0 2px #48bb78;
        }

        .dnf-btn {
            background: #f56565;
            color: white;
        }

        .dnf-btn:hover {
            background: #e53e3e;
        }

        .dnf-btn.active {
            background: #c53030;
            box-shadow: 0 0 0 2px #f56565;
        }

        .clear-status-btn {
            background: #a0aec0;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }

        .clear-status-btn:hover {
            background: #718096;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .runner-item {
                grid-template-columns: 1fr auto;
                gap: 10px;
            }

            .lap-controls {
                grid-column: 1 / -1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-top: 10px;
            }

            .lap-btn {
                flex: 1;
                margin-right: 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .section {
                padding: 15px;
            }

            .section h2 {
                font-size: 1.2em;
            }

            .runner-name {
                font-size: 1em;
            }

            .lap-count {
                font-size: 1.3em;
            }

            .lap-btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="login-screen">
        <h1>Admin Login</h1>
        <input type="password" id="password-input" placeholder="Enter password" />
        <button onclick="login()">Login</button>
        <div class="error-message" id="error-message">Incorrect password</div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="container">
            <h1>Lap Tracker Admin</h1>
            <div class="header-controls">
                <div class="status" id="status">Connected</div>
                <div>
                    <button class="init-btn" onclick="initializeData()">Initialize Race Data</button>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- 100 Mile Teams Section -->
            <div class="section">
                <h2>100 Mile Teams (160km Target)</h2>
                <div id="teams-list"></div>
            </div>

            <!-- 100km Solo Section -->
            <div class="section">
                <h2>100km Solo</h2>
                <div id="solo-list"></div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // CHANGE THIS PASSWORD
        const ADMIN_PASSWORD = "urcm2024";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFG3oclIU45jyfzh9uIe2k-Um-iNWv2_c",
            authDomain: "urcm-race.firebaseapp.com",
            databaseURL: "https://urcm-race-default-rtdb.firebaseio.com",
            projectId: "urcm-race",
            storageBucket: "urcm-race.firebasestorage.app",
            messagingSenderId: "806959334832",
            appId: "1:806959334832:web:a7a54b70400ba2e8028275"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // Login functionality
        function login() {
            const password = document.getElementById('password-input').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function showAdminPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadData();
        }

        // Allow Enter key to login
        document.getElementById('password-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Initialize race data
        function initializeData() {
            if (!confirm('This will reset all lap counts to 0. Continue?')) return;

            // Generate 40 teams
            const teams = {};
            for (let i = 1; i <= 40; i++) {
                teams[`team${i}`] = { 
                    name: `Team ${i}`, 
                    laps: 0,
                    status: null,
                    startTime: null,
                    finishTime: null,
                    stopTime: null
                };
            }

            // Generate 25 solo runners
            const solo = {};
            for (let i = 1; i <= 25; i++) {
                solo[`solo${i}`] = { 
                    name: `Runner ${i}`, 
                    laps: 0,
                    status: null,
                    startTime: null,
                    finishTime: null,
                    stopTime: null
                };
            }

            const initialData = {
                teams: teams,
                solo: solo
            };

            database.ref('/').set(initialData).then(() => {
                alert('Race data initialized successfully! 40 teams and 25 solo runners created.');
                // Force reload data to ensure it displays
                loadData();
            }).catch((error) => {
                alert('Error initializing data: ' + error.message);
                console.error('Initialization error:', error);
            });
        }

        // Load and listen to data
        function loadData() {
            database.ref('/').on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Data received from Firebase:', data);
                if (data) {
                    const teams = data.teams || {};
                    const solo = data.solo || {};
                    console.log('Teams count:', Object.keys(teams).length);
                    console.log('Solo count:', Object.keys(solo).length);
                    renderTeams(teams);
                    renderSolo(solo);
                    document.getElementById('status').textContent = 'Connected - Live';
                } else {
                    console.log('No data found in Firebase');
                    document.getElementById('teams-list').innerHTML = '<p>No teams found. Click "Initialize Race Data" to create teams.</p>';
                    document.getElementById('solo-list').innerHTML = '<p>No solo runners found. Click "Initialize Race Data" to create runners.</p>';
                }
            }, (error) => {
                console.error('Firebase error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            });
        }

        function renderTeams(teams) {
            const teamsList = document.getElementById('teams-list');
            const teamsArray = Object.entries(teams).map(([id, team]) => ({
                id,
                ...team
            }));

            teamsList.innerHTML = teamsArray.map(team => {
                const distance = team.laps * 5;
                const status = team.status || '';
                const isFinisher = status === 'finisher';
                const isDNF = status === 'dnf';
                return `
                    <div class="runner-item">
                        <div class="runner-info">
                            <div class="name-edit-container">
                                <div class="runner-name">${team.name}</div>
                                <button class="edit-btn" data-category="teams" data-id="${team.id}" data-name="${team.name.replace(/"/g, '&quot;')}" title="Edit name">✏️</button>
                            </div>
                            <div class="runner-stats">${distance}km completed</div>
                        </div>
                        <div class="lap-count">${team.laps}</div>
                        <div class="lap-controls">
                            <button class="lap-btn" onclick="addLap('teams', '${team.id}')">
                                + LAP COMPLETE
                            </button>
                            ${team.laps > 0 ? `<button class="undo-btn" onclick="removeLap('teams', '${team.id}')">Undo</button>` : ''}
                            <button class="status-btn finisher-btn ${isFinisher ? 'active' : ''}" onclick="setStatus('teams', '${team.id}', 'finisher')" title="Mark as Finisher">✓ Finisher</button>
                            <button class="status-btn dnf-btn ${isDNF ? 'active' : ''}" onclick="setStatus('teams', '${team.id}', 'dnf')" title="Mark as DNF">DNF</button>
                            ${status ? `<button class="clear-status-btn" onclick="setStatus('teams', '${team.id}', '')" title="Clear status">Clear</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit buttons
            teamsList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    const id = this.getAttribute('data-id');
                    const currentName = this.getAttribute('data-name');
                    editName(category, id, currentName);
                });
            });
        }

        function renderSolo(solo) {
            const soloList = document.getElementById('solo-list');
            const soloArray = Object.entries(solo).map(([id, runner]) => ({
                id,
                ...runner
            }));

            soloList.innerHTML = soloArray.map(runner => {
                const distance = runner.laps * 5;
                const status = runner.status || '';
                const isFinisher = status === 'finisher';
                const isDNF = status === 'dnf';
                return `
                    <div class="runner-item">
                        <div class="runner-info">
                            <div class="name-edit-container">
                                <div class="runner-name">${runner.name}</div>
                                <button class="edit-btn" data-category="solo" data-id="${runner.id}" data-name="${runner.name.replace(/"/g, '&quot;')}" title="Edit name">✏️</button>
                            </div>
                            <div class="runner-stats">${distance}km completed</div>
                        </div>
                        <div class="lap-count">${runner.laps}</div>
                        <div class="lap-controls">
                            <button class="lap-btn" onclick="addLap('solo', '${runner.id}')">
                                + LAP COMPLETE
                            </button>
                            ${runner.laps > 0 ? `<button class="undo-btn" onclick="removeLap('solo', '${runner.id}')">Undo</button>` : ''}
                            <button class="status-btn finisher-btn ${isFinisher ? 'active' : ''}" onclick="setStatus('solo', '${runner.id}', 'finisher')" title="Mark as Finisher">✓ Finisher</button>
                            <button class="status-btn dnf-btn ${isDNF ? 'active' : ''}" onclick="setStatus('solo', '${runner.id}', 'dnf')" title="Mark as DNF">DNF</button>
                            ${status ? `<button class="clear-status-btn" onclick="setStatus('solo', '${runner.id}', '')" title="Clear status">Clear</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit buttons
            soloList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    const id = this.getAttribute('data-id');
                    const currentName = this.getAttribute('data-name');
                    editName(category, id, currentName);
                });
            });
        }

        // Add a lap
        function addLap(category, runnerId) {
            const lapsRef = database.ref(`${category}/${runnerId}/laps`);
            const startTimeRef = database.ref(`${category}/${runnerId}/startTime`);
            
            lapsRef.transaction((currentLaps) => {
                const newLaps = (currentLaps || 0) + 1;
                
                // If this is the first lap, set start time
                if (newLaps === 1) {
                    startTimeRef.once('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            startTimeRef.set(Date.now());
                        }
                    });
                }
                
                return newLaps;
            });
        }

        // Remove a lap (undo)
        function removeLap(category, runnerId) {
            const ref = database.ref(`${category}/${runnerId}/laps`);
            ref.transaction((currentLaps) => {
                return Math.max(0, (currentLaps || 0) - 1);
            });
        }

        // Edit name
        function editName(category, runnerId, currentName) {
            // Decode HTML entities if needed
            const decodedName = currentName.replace(/&quot;/g, '"');
            const newName = prompt(`Edit ${category === 'teams' ? 'Team' : 'Runner'} name:`, decodedName);
            if (newName && newName.trim() !== '' && newName !== decodedName) {
                const ref = database.ref(`${category}/${runnerId}/name`);
                ref.set(newName.trim()).then(() => {
                    console.log('Name updated successfully');
                }).catch((error) => {
                    alert('Error updating name: ' + error.message);
                });
            }
        }

        // Set status (finisher or DNF)
        function setStatus(category, runnerId, status) {
            const statusRef = database.ref(`${category}/${runnerId}/status`);
            const finishTimeRef = database.ref(`${category}/${runnerId}/finishTime`);
            const stopTimeRef = database.ref(`${category}/${runnerId}/stopTime`);
            
            if (status === '') {
                // Clear status, finish time, and stop time
                statusRef.remove().then(() => {
                    finishTimeRef.remove();
                    stopTimeRef.remove();
                    console.log('Status cleared');
                }).catch((error) => {
                    alert('Error clearing status: ' + error.message);
                });
            } else {
                statusRef.set(status).then(() => {
                    // If marking as finisher, set finish time and remove stop time
                    if (status === 'finisher') {
                        finishTimeRef.set(Date.now());
                        stopTimeRef.remove();
                    } else if (status === 'dnf') {
                        // If DNF, set stop time to freeze the timer and remove finish time
                        stopTimeRef.set(Date.now());
                        finishTimeRef.remove();
                    }
                    console.log(`Status set to ${status}`);
                }).catch((error) => {
                    alert('Error setting status: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
