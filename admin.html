<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URCM - Admin Lap Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .login-container h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .login-container input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .login-container button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-container button:hover {
            background: #5568d3;
        }

        .error-message {
            color: #e53e3e;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        /* Admin Panel */
        #admin-panel {
            display: none;
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
        }

        .logout-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .init-btn {
            padding: 10px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .init-btn:hover {
            background: #38a169;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .runner-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .runner-item:last-child {
            border-bottom: none;
        }

        .runner-info {
            display: flex;
            flex-direction: column;
        }

        .runner-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .runner-stats {
            font-size: 0.9em;
            color: #718096;
        }

        .lap-count {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            text-align: center;
            min-width: 80px;
        }

        .lap-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .lap-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .lap-btn:active {
            transform: translateY(0);
        }

        .undo-btn {
            padding: 8px 16px;
            background: #fc8181;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .undo-btn:hover {
            background: #f56565;
        }

        .edit-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }

        .edit-btn:hover {
            background: #38a169;
        }

        .name-edit-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .finisher-btn {
            background: #48bb78;
            color: white;
        }

        .finisher-btn:hover {
            background: #38a169;
        }

        .finisher-btn.active {
            background: #2f855a;
            box-shadow: 0 0 0 2px #48bb78;
        }

        .dnf-btn {
            background: #f56565;
            color: white;
        }

        .dnf-btn:hover {
            background: #e53e3e;
        }

        .dnf-btn.active {
            background: #c53030;
            box-shadow: 0 0 0 2px #f56565;
        }

        .clear-status-btn {
            background: #a0aec0;
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }

        .clear-status-btn:hover {
            background: #718096;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .runner-item {
                grid-template-columns: 1fr auto;
                gap: 10px;
            }

            .lap-controls {
                grid-column: 1 / -1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-top: 10px;
            }

            .lap-btn {
                flex: 1;
                margin-right: 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .section {
                padding: 15px;
            }

            .section h2 {
                font-size: 1.2em;
            }

            .runner-name {
                font-size: 1em;
            }

            .lap-count {
                font-size: 1.3em;
            }

            .lap-btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="login-screen">
        <h1>Admin Login</h1>
        <input type="password" id="password-input" placeholder="Enter password" />
        <button onclick="login()">Login</button>
        <div class="error-message" id="error-message">Incorrect password</div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="container">
            <h1>Lap Tracker Admin</h1>
            <div class="header-controls">
                <div class="status" id="status">Connected</div>
                <div>
                    <button class="init-btn" onclick="initializeData()">Initialize Race Data</button>
                    <button class="init-btn" id="start-race-btn" onclick="startRace()" style="background: #f56565; margin-left: 10px;">Start Race</button>
                    <div id="race-start-time" style="color: rgba(255,255,255,0.9); font-size: 0.9em; margin-left: 10px; display: inline-block;"></div>
                    <button class="logout-btn" onclick="logout()" style="margin-left: 10px;">Logout</button>
                </div>
            </div>

            <!-- 100 Mile Teams Section -->
            <div class="section">
                <h2>100 Mile Teams (160km Target)</h2>
                <div id="teams-list"></div>
            </div>

            <!-- 100km Solo Section -->
            <div class="section">
                <h2>100km Solo</h2>
                <div id="solo-list"></div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // CHANGE THIS PASSWORD
        const ADMIN_PASSWORD = "urcm2024";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCFG3oclIU45jyfzh9uIe2k-Um-iNWv2_c",
            authDomain: "urcm-race.firebaseapp.com",
            databaseURL: "https://urcm-race-default-rtdb.firebaseio.com",
            projectId: "urcm-race",
            storageBucket: "urcm-race.firebasestorage.app",
            messagingSenderId: "806959334832",
            appId: "1:806959334832:web:a7a54b70400ba2e8028275"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Check if already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            showAdminPanel();
        }

        // Login functionality
        function login() {
            const password = document.getElementById('password-input').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                document.getElementById('error-message').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function showAdminPanel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadData();
        }

        // Allow Enter key to login
        document.getElementById('password-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Initialize race data
        function initializeData() {
            if (!confirm('This will reset all lap counts to 0. Continue?')) return;

            // Generate 40 teams
            const teams = {};
            for (let i = 1; i <= 40; i++) {
                teams[`team${i}`] = { 
                    name: `Team ${i}`, 
                    laps: 0,
                    status: null,
                    startTime: null,
                    finishTime: null,
                    stopTime: null
                };
            }

            // Generate 25 solo runners
            const solo = {};
            for (let i = 1; i <= 25; i++) {
                solo[`solo${i}`] = { 
                    name: `Runner ${i}`, 
                    laps: 0,
                    status: null,
                    startTime: null,
                    finishTime: null,
                    stopTime: null
                };
            }

            const initialData = {
                teams: teams,
                solo: solo
            };

            console.log('Initializing data with:', Object.keys(teams).length, 'teams and', Object.keys(solo).length, 'solo runners');
            console.log('Team keys:', Object.keys(teams));
            console.log('Solo keys:', Object.keys(solo));

            // First remove all existing data, then set new data
            database.ref('/').remove().then(() => {
                console.log('Old data removed, setting new data...');
                return database.ref('/').set(initialData);
            }).then(() => {
                console.log('Data set successfully. Verifying...');
                // Verify the data was set correctly
                return database.ref('/').once('value');
            }).then((snapshot) => {
                const data = snapshot.val();
                const teamCount = data && data.teams ? Object.keys(data.teams).length : 0;
                const soloCount = data && data.solo ? Object.keys(data.solo).length : 0;
                console.log('Verification: Found', teamCount, 'teams and', soloCount, 'solo runners in Firebase');
                
                if (teamCount === 40 && soloCount === 25) {
                    alert('Race data initialized successfully! 40 teams and 25 solo runners created.');
                } else {
                    alert(`Warning: Expected 40 teams and 25 solo runners, but found ${teamCount} teams and ${soloCount} solo runners. Please check the console.`);
                }
                // Force reload data to ensure it displays
                loadData();
            }).catch((error) => {
                alert('Error initializing data: ' + error.message);
                console.error('Initialization error:', error);
            });
        }

        let currentRaceStartTime = null;
        let currentTeams = {};
        let currentSolo = {};
        let timerUpdateInterval = null;

        // Load and listen to data
        function loadData() {
            database.ref('/').on('value', (snapshot) => {
                const data = snapshot.val();
                console.log('Data received from Firebase:', data);
                if (data) {
                    currentTeams = data.teams || {};
                    currentSolo = data.solo || {};
                    currentRaceStartTime = data.raceStartTime || null;
                    
                    console.log('Teams count:', Object.keys(currentTeams).length);
                    console.log('Solo count:', Object.keys(currentSolo).length);
                    console.log('Race start time:', currentRaceStartTime);
                    
                    // Update race start time display
                    updateRaceStartTimeDisplay(currentRaceStartTime);
                    
                    // Render initial data
                    renderTeams(currentTeams, currentRaceStartTime);
                    renderSolo(currentSolo, currentRaceStartTime);
                    
                    // Start real-time timer updates if race has started
                    if (currentRaceStartTime) {
                        startTimerUpdates();
                    } else {
                        stopTimerUpdates();
                    }
                    
                    document.getElementById('status').textContent = 'Connected - Live';
                } else {
                    console.log('No data found in Firebase');
                    document.getElementById('teams-list').innerHTML = '<p>No teams found. Click "Initialize Race Data" to create teams.</p>';
                    document.getElementById('solo-list').innerHTML = '<p>No solo runners found. Click "Initialize Race Data" to create runners.</p>';
                    stopTimerUpdates();
                }
            }, (error) => {
                console.error('Firebase error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            });
        }

        // Start real-time timer updates
        function startTimerUpdates() {
            if (timerUpdateInterval) return; // Already running
            
            timerUpdateInterval = setInterval(() => {
                if (currentRaceStartTime) {
                    renderTeams(currentTeams, currentRaceStartTime);
                    renderSolo(currentSolo, currentRaceStartTime);
                }
            }, 1000); // Update every second
        }

        // Stop real-time timer updates
        function stopTimerUpdates() {
            if (timerUpdateInterval) {
                clearInterval(timerUpdateInterval);
                timerUpdateInterval = null;
            }
        }

        // Start race - set race start time
        function startRace() {
            if (!confirm('Start the race now? This will set the race start time and all timers will begin counting.')) return;
            
            const raceStartTime = Date.now();
            database.ref('/raceStartTime').set(raceStartTime).then(() => {
                currentRaceStartTime = raceStartTime;
                startTimerUpdates(); // Start real-time updates
                alert('Race started! All timers are now running.');
                console.log('Race started at:', new Date(raceStartTime).toLocaleString());
            }).catch((error) => {
                alert('Error starting race: ' + error.message);
                console.error('Start race error:', error);
            });
        }

        // Update race start time display
        function updateRaceStartTimeDisplay(raceStartTime) {
            const displayEl = document.getElementById('race-start-time');
            const startBtn = document.getElementById('start-race-btn');
            
            if (raceStartTime) {
                const startDate = new Date(raceStartTime);
                const timeString = startDate.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                displayEl.textContent = `Race started: ${timeString}`;
                startBtn.textContent = 'Race Started';
                startBtn.disabled = true;
                startBtn.style.background = '#48bb78';
                startBtn.style.cursor = 'not-allowed';
            } else {
                displayEl.textContent = '';
                startBtn.textContent = 'Start Race';
                startBtn.disabled = false;
                startBtn.style.background = '#f56565';
                startBtn.style.cursor = 'pointer';
            }
        }

        function renderTeams(teams, raceStartTime) {
            const teamsList = document.getElementById('teams-list');
            if (!teamsList) {
                console.error('teams-list element not found');
                return;
            }
            
            if (!teams || Object.keys(teams).length === 0) {
                teamsList.innerHTML = '<p>No teams found. Click "Initialize Race Data" to create teams.</p>';
                return;
            }
            
            const teamsArray = Object.entries(teams).map(([id, team]) => ({
                id,
                ...team
            }));

            // Sort teams by numeric order (team1, team2, ..., team40)
            teamsArray.sort((a, b) => {
                const numA = parseInt(a.id.replace('team', ''));
                const numB = parseInt(b.id.replace('team', ''));
                return numA - numB;
            });

            console.log('Rendering teams:', teamsArray.length);
            teamsList.innerHTML = teamsArray.map(team => {
                // Use race start time if available, otherwise use individual startTime
                const startTime = raceStartTime || team.startTime;
                const timeDisplay = startTime ? formatTime(startTime, team.finishTime, team.stopTime, team.status || '') : '-';
                const distance = team.laps * 5;
                const status = team.status || '';
                const isFinisher = status === 'finisher';
                const isDNF = status === 'dnf';
                return `
                    <div class="runner-item">
                        <div class="runner-info">
                            <div class="name-edit-container">
                                <div class="runner-name">${team.name}</div>
                                <button class="edit-btn" data-category="teams" data-id="${team.id}" data-name="${team.name.replace(/"/g, '&quot;')}" title="Edit name">✏️</button>
                            </div>
                            <div class="runner-stats">${distance}km completed ${timeDisplay !== '-' ? '• ' + timeDisplay : ''}</div>
                        </div>
                        <div class="lap-count">${team.laps}</div>
                        <div class="lap-controls">
                            <button class="lap-btn" onclick="addLap('teams', '${team.id}')">
                                + LAP COMPLETE
                            </button>
                            ${team.laps > 0 ? `<button class="undo-btn" onclick="removeLap('teams', '${team.id}')">Undo</button>` : ''}
                            <button class="status-btn finisher-btn ${isFinisher ? 'active' : ''}" onclick="setStatus('teams', '${team.id}', 'finisher')" title="Mark as Finisher">✓ Finisher</button>
                            <button class="status-btn dnf-btn ${isDNF ? 'active' : ''}" onclick="setStatus('teams', '${team.id}', 'dnf')" title="Mark as DNF">DNF</button>
                            ${status ? `<button class="clear-status-btn" onclick="setStatus('teams', '${team.id}', '')" title="Clear status">Clear</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit buttons
            teamsList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    const id = this.getAttribute('data-id');
                    const currentName = this.getAttribute('data-name');
                    editName(category, id, currentName);
                });
            });
        }

        function renderSolo(solo, raceStartTime) {
            const soloList = document.getElementById('solo-list');
            if (!soloList) {
                console.error('solo-list element not found');
                return;
            }
            
            if (!solo || Object.keys(solo).length === 0) {
                soloList.innerHTML = '<p>No solo runners found. Click "Initialize Race Data" to create runners.</p>';
                return;
            }
            
            const soloArray = Object.entries(solo).map(([id, runner]) => ({
                id,
                ...runner
            }));

            // Sort solo runners by numeric order (solo1, solo2, ..., solo25)
            soloArray.sort((a, b) => {
                const numA = parseInt(a.id.replace('solo', ''));
                const numB = parseInt(b.id.replace('solo', ''));
                return numA - numB;
            });

            console.log('Rendering solo runners:', soloArray.length);
            soloList.innerHTML = soloArray.map(runner => {
                // Use race start time if available, otherwise use individual startTime
                const startTime = raceStartTime || runner.startTime;
                const timeDisplay = startTime ? formatTime(startTime, runner.finishTime, runner.stopTime, runner.status || '') : '-';
                const distance = runner.laps * 5;
                const status = runner.status || '';
                const isFinisher = status === 'finisher';
                const isDNF = status === 'dnf';
                return `
                    <div class="runner-item">
                        <div class="runner-info">
                            <div class="name-edit-container">
                                <div class="runner-name">${runner.name}</div>
                                <button class="edit-btn" data-category="solo" data-id="${runner.id}" data-name="${runner.name.replace(/"/g, '&quot;')}" title="Edit name">✏️</button>
                            </div>
                            <div class="runner-stats">${distance}km completed ${timeDisplay !== '-' ? '• ' + timeDisplay : ''}</div>
                        </div>
                        <div class="lap-count">${runner.laps}</div>
                        <div class="lap-controls">
                            <button class="lap-btn" onclick="addLap('solo', '${runner.id}')">
                                + LAP COMPLETE
                            </button>
                            ${runner.laps > 0 ? `<button class="undo-btn" onclick="removeLap('solo', '${runner.id}')">Undo</button>` : ''}
                            <button class="status-btn finisher-btn ${isFinisher ? 'active' : ''}" onclick="setStatus('solo', '${runner.id}', 'finisher')" title="Mark as Finisher">✓ Finisher</button>
                            <button class="status-btn dnf-btn ${isDNF ? 'active' : ''}" onclick="setStatus('solo', '${runner.id}', 'dnf')" title="Mark as DNF">DNF</button>
                            ${status ? `<button class="clear-status-btn" onclick="setStatus('solo', '${runner.id}', '')" title="Clear status">Clear</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit buttons
            soloList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    const id = this.getAttribute('data-id');
                    const currentName = this.getAttribute('data-name');
                    editName(category, id, currentName);
                });
            });
        }

        // Format time duration
        function formatTime(startTime, finishTime, stopTime, status) {
            if (!startTime) return '-';
            
            // If DNF, use stopTime to freeze the timer; otherwise use finishTime or current time
            let endTime;
            if (status === 'dnf' && stopTime) {
                endTime = stopTime; // Timer stops when DNF is set
            } else if (finishTime) {
                endTime = finishTime; // Timer stops when finisher is set
            } else {
                endTime = Date.now(); // Timer continues running
            }
            
            const duration = endTime - startTime;
            
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((duration % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // Add a lap
        function addLap(category, runnerId) {
            const lapsRef = database.ref(`${category}/${runnerId}/laps`);
            
            lapsRef.transaction((currentLaps) => {
                const newLaps = (currentLaps || 0) + 1;
                // Note: We no longer set individual startTime here - timer uses raceStartTime
                return newLaps;
            });
        }

        // Remove a lap (undo)
        function removeLap(category, runnerId) {
            const ref = database.ref(`${category}/${runnerId}/laps`);
            ref.transaction((currentLaps) => {
                return Math.max(0, (currentLaps || 0) - 1);
            });
        }

        // Edit name
        function editName(category, runnerId, currentName) {
            // Decode HTML entities if needed
            const decodedName = currentName.replace(/&quot;/g, '"');
            const newName = prompt(`Edit ${category === 'teams' ? 'Team' : 'Runner'} name:`, decodedName);
            if (newName && newName.trim() !== '' && newName !== decodedName) {
                const ref = database.ref(`${category}/${runnerId}/name`);
                ref.set(newName.trim()).then(() => {
                    console.log('Name updated successfully');
                }).catch((error) => {
                    alert('Error updating name: ' + error.message);
                });
            }
        }

        // Set status (finisher or DNF)
        function setStatus(category, runnerId, status) {
            const statusRef = database.ref(`${category}/${runnerId}/status`);
            const finishTimeRef = database.ref(`${category}/${runnerId}/finishTime`);
            const stopTimeRef = database.ref(`${category}/${runnerId}/stopTime`);
            
            if (status === '') {
                // Clear status, finish time, and stop time
                statusRef.remove().then(() => {
                    finishTimeRef.remove();
                    stopTimeRef.remove();
                    console.log('Status cleared');
                }).catch((error) => {
                    alert('Error clearing status: ' + error.message);
                });
            } else {
                statusRef.set(status).then(() => {
                    // If marking as finisher, set finish time and remove stop time
                    if (status === 'finisher') {
                        finishTimeRef.set(Date.now());
                        stopTimeRef.remove();
                    } else if (status === 'dnf') {
                        // If DNF, set stop time to freeze the timer and remove finish time
                        stopTimeRef.set(Date.now());
                        finishTimeRef.remove();
                    }
                    console.log(`Status set to ${status}`);
                }).catch((error) => {
                    alert('Error setting status: ' + error.message);
                });
            }
        }
    </script>
</body>
</html>
